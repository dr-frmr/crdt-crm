<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>KinoContacts</title>
    <link rel="stylesheet" href="/contacts:crdt-crm:mothu.eth/style.css">
    <link rel="icon" href="/contacts:crdt-crm:mothu.eth/favicon.ico" type="image/x-icon">
</head>

<body>
    <main>
        <h1>Contacts</h1>

        <div id="contacts"></div>

        <h1>Add Contact</h1>

        <form id="addContactForm">
            <label for="name">Name:</label>
            <input type="text" id="name" name="name" required>
            <br>
            <label for="desc">Description:</label>
            <input type="text" id="desc" name="desc" required>
            <br>
            <div id="customFieldsContainer"></div>
            <button type="button" id="addCustomFieldBtn">Add Custom Field</button>
            <br>
            <button type="submit">Add</button>
        </form>

        <h1>Peers</h1>

        <div id="peers"></div>

        <form id="addPeerForm">
            <label for="peerAddress">Peer:</label>
            <input type="text" id="peer" name="peer" required>
            <br>
            <button type="submit">Add</button>
        </form>

        <br>
        <br>
        <form id="clearStateForm">
            <button type="submit">Clear State</button>
        </form>

        <script>
            // set `our` to the string stored at /our path
            let our = '';
            fetch('/our')
                .then(response => response.text())
                .then(data => {
                    our = data + '@contacts:crdt-crm:mothu.eth';
                });

            document.getElementById('addCustomFieldBtn').addEventListener('click', function () {
                const container = document.getElementById('customFieldsContainer');
                const inputGroup = document.createElement('div');
                inputGroup.innerHTML = `
                    <input type="text" placeholder="Field Name" name="customFieldName[]" required>
                    <input type="text" placeholder="Field Value" name="customFieldValue[]" required>
                    <button type="button" class="removeFieldBtn">X</button>
                `;
                container.appendChild(inputGroup);

                inputGroup.querySelector('.removeFieldBtn').addEventListener('click', function () {
                    inputGroup.remove();
                });
            });

            // HTTP GET request for /state path
            // then display the result in the page
            fetch('/contacts:crdt-crm:mothu.eth/state')
                .then(response => response.json())
                .then(data => {
                    updateContactsAndPeers(data);
                });

            // connect to /updates websocket and listen for updates
            // when we receive an update, display it in the page
            // if URL ends with a slash, strip it
            let url = window.location.href;
            if (url.endsWith('/')) {
                url = url.slice(0, -1);
            }
            url = url + '/updates';
            // strip the protocol from the URL and replace it with ws
            url = url.replace(/^http/, 'ws');
            url = url.replace(/^https/, 'wss');
            const ws = new WebSocket(url);
            ws.onmessage = event => {
                const data = JSON.parse(event.data);
                updateContactsAndPeers(data);
            };

            function updateContactsAndPeers(data) {
                // Convert contacts to a properly formatted HTML structure
                const contactsHtml = Object.entries(data.contacts).map(([id, contact]) => {
                    return `<div class="contact">
                                <h2>${id}</h2>
                                <p class="editableDescription" contenteditable="false" data-contact-id="${id}">${contact.description}</p>
                                <div class="socials">${Object.entries(contact.socials).map(([key, value]) => `
                                    <span class="editableSocial" contenteditable="false" data-contact-id="${id}" data-social-key="${key}">${key}: ${value}</span>
                                    <button type="button" class="removeSocialBtn" data-contact-id="${id}" data-social-key="${key}">Remove</button>
                                `).join('<br>')}</div>
                                <div class="addSocialForm" data-contact-id="${id}">
                                    <input type="text" placeholder="Social Media Name" class="socialKeyInput">
                                    <input type="text" placeholder="Social Media Handle" class="socialValueInput">
                                    <button type="button" class="submitSocialBtn">Add Social</button>
                                </div>
                                <button type="button" class="deleteContactBtn" data-contact-id="${id}">Delete</button>
                            </div>`;
                }).join('');
                document.getElementById("contacts").innerHTML = contactsHtml;

                // Add event listeners for delete buttons
                document.querySelectorAll('.deleteContactBtn').forEach(button => {
                    button.addEventListener('click', function () {
                        const contactId = this.getAttribute('data-contact-id');
                        fetch('/contacts:crdt-crm:mothu.eth/post', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ "RemoveContact": contactId }),
                        });
                    });
                });

                // Make description fields editable on click and save on enter
                document.querySelectorAll('.editableDescription').forEach(description => {
                    description.addEventListener('click', function () {
                        this.contentEditable = true;
                        this.focus();
                    });
                    description.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.contentEditable = false;
                            const newDescription = this.innerText;
                            const contactId = this.getAttribute('data-contact-id');
                            fetch('/contacts:crdt-crm:mothu.eth/post', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ "EditContactDescription": [contactId, newDescription] }),
                            });
                        }
                    });
                });

                // Add event listeners for socials edit and remove buttons
                document.querySelectorAll('.editableSocial').forEach(social => {
                    social.addEventListener('click', function () {
                        this.contentEditable = true;
                        this.focus();
                    });
                    social.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.contentEditable = false;
                            const newSocialValue = this.innerText.split(': ')[1];
                            const contactId = this.getAttribute('data-contact-id');
                            const socialKey = this.getAttribute('data-social-key');
                            fetch('/contacts:crdt-crm:mothu.eth/post', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ "EditContactSocial": [contactId, socialKey, newSocialValue] }),
                            });
                        }
                    });
                });

                document.querySelectorAll('.removeSocialBtn').forEach(button => {
                    button.addEventListener('click', function () {
                        const contactId = this.getAttribute('data-contact-id');
                        const socialKey = this.getAttribute('data-social-key');
                        fetch('/contacts:crdt-crm:mothu.eth/post', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ "RemoveContactSocial": [contactId, socialKey] }),
                        });
                    });
                });

                // Add event listener for add social button within the form
                document.querySelectorAll('.submitSocialBtn').forEach(button => {
                    button.addEventListener('click', function () {
                        const contactId = this.closest('.addSocialForm').getAttribute('data-contact-id');
                        const socialKey = this.previousElementSibling.previousElementSibling.value;
                        const socialValue = this.previousElementSibling.value;
                        if (socialKey && socialValue) {
                            fetch('/contacts:crdt-crm:mothu.eth/post', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ "EditContactSocial": [contactId, socialKey, socialValue] }),
                            }).then(() => {
                                this.previousElementSibling.previousElementSibling.value = ''; // Clear the social media name input
                                this.previousElementSibling.value = ''; // Clear the social media handle input
                            });
                        }
                    });
                });

                // Convert peers to a properly formatted HTML structure
                const peersHtml = Object.entries(data.peers).map(([address, status]) => {
                    return `<div class="peer">
                                <h2>${address.split('@')[0]}</h2>
                                <p>Status: ${status}</p>
                            </div>`;
                }).join('');
                document.getElementById("peers").innerHTML = peersHtml;
            }

            // HTTP POST request to /post path
            // based on the form data
            document.getElementById('addContactForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = {};
                for (const [key, value] of formData.entries()) {
                    data[key] = value;
                }
                fetch('/contacts:crdt-crm:mothu.eth/post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        "AddContact": [
                            formData.get('name'),
                            {
                                "description": formData.get('desc'),
                                "socials": Object.fromEntries(
                                    formData.getAll('customFieldName[]').map((fieldName, index) => [
                                        fieldName,
                                        formData.getAll('customFieldValue[]')[index]
                                    ])
                                )
                            }
                        ]
                    }),
                }).then(response => {
                    if (response.ok) {
                        e.target.reset(); // Clear the form values upon successful submit
                        document.getElementById('customFieldsContainer').innerHTML = ''; // Clear custom fields as well
                    }
                });
            });

            // HTTP POST request to /post path
            // based on the form data
            document.getElementById('addPeerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const data = {};
                for (const [key, value] of formData.entries()) {
                    data[key] = value;
                }
                let peer = formData.get('peer');
                if (!peer.endsWith('@contacts:crdt-crm:mothu.eth')) {
                    peer = peer + '@contacts:crdt-crm:mothu.eth';
                }
                fetch('/contacts:crdt-crm:mothu.eth/post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        "AddPeer": [
                            peer,
                            "ReadWrite"
                        ]
                    }),
                }).then(response => {
                    if (response.ok) {
                        e.target.reset(); // Clear the form values upon successful submit
                    }
                });
            });

            document.getElementById('clearStateForm').addEventListener('submit', (e) => {
                e.preventDefault();
                fetch('/contacts:crdt-crm:mothu.eth/post', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ "ClearState": our }),
                });
            });
        </script>
    </main>
</body>

</html>